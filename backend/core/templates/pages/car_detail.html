{% extends 'base2.html' %}
{% load static i18n %}

{% block title %}{{ car.name }} - Prestige Cars 24{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"/>
<style>
.car-detail-page .main-content {
    background: #fff !important;
}
.car-tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}
.car-tag-item {
    padding: 8px 20px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 14px;
    color: #333;
}
.services-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.services-list li {
    padding: 12px 0;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 16px;
}
.services-list li i {
    color: #bfa37c;
}
</style>
{% endblock %}

{% block content %}
{% include 'includes/header.html' %}

<div class="car-detail-page">
    <div class="main-content" style="background-color: #fff;">
        <div class="properties-details">
            <div class="tf-container tf-spacing-7 tf-spacing-7-mobile">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="properties-title ">
                                <div class="d-flex align-items-center justify-content-between flex-wrap gap_12">
                                    <div>
                                        <div class="wrap-tag d-flex gap_8 mb_12">
                                            <div class="tag categoreis text-button-small text_primary-color">
                                               {{ car.category.name }}
                                            </div>
                                        </div>
                                        <h4>{{ car.name }}</h4>
                                    </div>
                                    <h4 class="price">€{{ car.price_per_day|floatformat:0 }}<span
                                            class="text_secondary-color text-body-1">/day</span>
                                    </h4>
                                </div>
                            </div>
                        <!-- Gallery -->
                        <div class="wrap-thumbs mb_30">
                            <div class="thumb-main-2 mb_20">
                                <a href="{{ car.main_image }}" data-fancybox="gallery" class="img-style">
                                    <img width="800" height="500" loading="eager" src="{{ car.main_image }}" alt="{{ car.name }}" class="gallery-thumb"">
                                </a>
                            </div>
                            {% if car.image_2 or car.image_3 or car.image_4 %}
                            <div class="d-flex gap_15">
                                {% if car.image_2 %}
                                <a href="{{ car.image_2 }}" data-fancybox="gallery" style="flex:1;">
                                    <img src="{{ car.image_2 }}" alt="{{ car.name }}" class="gallery-thumb">
                                </a>
                                {% endif %}
                                {% if car.image_3 %}
                                <a href="{{ car.image_3 }}" data-fancybox="gallery" style="flex:1;">
                                    <img src="{{ car.image_3 }}" alt="{{ car.name }}" class="gallery-thumb">
                                </a>
                                {% endif %}
                                {% if car.image_4 %}
                                <a href="{{ car.image_4 }}" data-fancybox="gallery" style="flex:1;">
                                    <img src="{{ car.image_4 }}" alt="{{ car.name }}" class="gallery-thumb">
                                </a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <!-- Description -->
                        <div class="properties-description mb_30">
                            <h5 class="properties-title mb_20">Description</h5>
                            <div class="text-body-2">{{ car.description|linebreaks }}</div>
                        </div>
                        <!-- Services -->
                        <div class="properties-services mb_30">
                            <h5 class="properties-title mb_20">Service Offered In This Vehicle</h5>
                            <p class="text-body-default mb_20">Whether for exclusive events, luxury travel, or unforgettable experiences, the {{ car.name }} offers a premium range of services.</p>
                            <ul class="services-list">
                                {% for feature in car.get_features_list %}
                                <li><i class="icon-CheckCircle"></i> {{ feature }}</li>
                                {% empty %}
                                <li><i class="icon-CheckCircle"></i> Premium Luxury Experience</li>
                                <li><i class="icon-CheckCircle"></i> 24/7 Customer Support</li>
                                <li><i class="icon-CheckCircle"></i> Airport Delivery Available</li>
                                <li><i class="icon-CheckCircle"></i> Full Insurance Included</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <div class="right sticky-top">
                            <div class="box-sellers mb_30">
                                <h5 class="mb_20">Features</h5>
                                
                                <!-- Tags -->
                                <div class="car-tags-list">
                                    <span class="car-tag-item">{{ car.seats }} Seats</span>
                                    <span class="car-tag-item">{{ car.transmission }}</span>
                                    {% for tag in car.get_tags_list %}
                                    <span class="car-tag-item">{{ tag }}</span>
                                    {% endfor %}
                                </div>

                                <!-- Price -->
                                <div class="mb_24">
                                    <h6 class="mb_12">Prices</h6>
                                    <div style="font-size: 42px; font-weight: 300; color: #0c1315;">
                                        <sup style="font-size: 20px;">€</sup>{{ car.price_per_day|floatformat:0 }}<span style="font-size: 16px; color: #666; font-weight: 400;"> / Per day</span>
                                    </div>
                                </div>

                                <hr class="mb_24">

                                <!-- Buttons -->
                                <a href="https://wa.me/393391069936?text=Hello!%20I%20want%20to%20book%20{{ car.name|urlencode }}" target="_blank" class="tf-btn btn-bg-1 w-full mb_12" data-gtag-event="whatsapp_car" data-gtag-car="{{ car.name }}">
                                    <span class="d-flex align-items-center gap_8"><i class="icon-ChatCircleDots"></i>Chat via WhatsApp</span>
                                    <span class="bg-effect"></span>
                                </a>
                                <a href="tel:+393391069936" data-gtag-event="phone_car" data-gtag-car="{{ car.name }}" class="tf-btn w-full mb_12">
                                    <span class="d-flex align-items-center gap_8"><i class="icon-PhoneCall"></i>Call +39 339 106 9936</span>
                                    <span class="bg-effect"></span>
                                </a>
                                <a href="mailto:booking@prestigecars24.com" data-gtag-event="email_car" data-gtag-car="{{ car.name }}" class="tf-btn w-full">
                                    <span class="d-flex align-items-center gap_8"><i class="icon-EnvelopeSimple"></i>Email Us</span>
                                    <span class="bg-effect"></span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Sticky Button -->
<div class="sticky-request-btn">
    <button id="open-request-modal" class="tf-btn btn-bg-1 w-full">
        <span class="d-flex align-items-center justify-content-center gap_8">
            <i class="icon-PaperPlaneTilt"></i> Send A Request
        </span>
        <span class="bg-effect"></span>
    </button>
</div>

<!-- Request Modal -->
<div id="request-modal" class="request-modal" style="display:none;">
    <div class="request-modal__overlay"></div>
    <div class="request-modal__box">
        <button class="request-modal__close" id="close-request-modal">&times;</button>
        <h4 class="text_white mb_8">Request {{ car.name }}</h4>
        <p class="text_color-1 mb_24">Fill in your details and we'll contact you shortly</p>
        
        <form id="car-request-form">
            {% csrf_token %}
            <input type="hidden" name="car_name" value="{{ car.name }}">
            <input type="hidden" name="car_url" value="{{ request.build_absolute_uri }}">
            <input type="hidden" name="full_phone" id="modal-full-phone">
            
            <div class="form-group mb_16">
                <label class="text_white mb_8 d-block">Phone *</label>
                <input type="tel" id="modal-phone-input" name="phone" class="form-input-modal" required>
            </div>
            
            <div class="form-group mb_16">
                <label class="text_white mb_8 d-block">Email *</label>
                <input type="email" name="email" class="form-input-modal" placeholder="your@email.com" required>
            </div>
            
            <div class="form-group mb_24">
                <label class="text_white mb_8 d-block">Preferred Date</label>
                <input type="date" name="date" class="form-input-modal">
            </div>
            
            <button type="submit" class="tf-btn btn-bg-1 w-full" id="modal-submit-btn">
                <span>Send Request</span>
                <span class="bg-effect"></span>
            </button>
        </form>
    </div>
</div>
<style>
div.properties-description.mb_30 > div > p {
    font-weight: 400;
}
div.properties-services.mb_30 > p  {
    font-weight: 400;
    font-size: 16px;
}
.is-horizontal .f-carousel__nav .f-button.is-prev, .is-horizontal .fancybox__nav .f-button.is-prev {
    overflow: hidden;
}
.is-horizontal .f-carousel__nav .f-button.is-next, .is-horizontal .fancybox__nav .f-button.is-next {
    overflow: hidden;
}
.gallery-thumb {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
}
.tf-spacing-7-mobile {
    padding-top: 40px;
}
@media (max-width: 768px) {
    .gallery-thumb {
        height: 100px;
    }
    .tf-spacing-7-mobile {
        padding-top: 20px;
    }
}
/* Sticky Button */
.sticky-request-btn {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 16px;
    background: #0c1315;
    border-top: 1px solid rgba(191,163,124,0.3);
    z-index: 9999;
    display: none;
}
@media (max-width: 991px) {
    .sticky-request-btn {
        display: block;
    }
}

/* Modal */
.request-modal {
    position: fixed;
    inset: 0;
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
}
.request-modal__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.8);
}
.request-modal__box {
    position: relative;
    background: #0c1315;
    padding: 32px;
    border-radius: 12px;
    border: 1px solid #bfa37c;
    max-width: 400px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}
.request-modal__close {
    position: absolute;
    top: 12px;
    right: 16px;
    background: none;
    border: none;
    color: #fff;
    font-size: 28px;
    cursor: pointer;
}
.form-input-modal {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 4px;
    color: #fff;
    font-size: 14px;
}
.form-input-modal:focus {
    outline: none;
    border-color: #bfa37c;
}
.form-input-modal::placeholder {
    color: rgba(255,255,255,0.5);
}

/* intl-tel-input в модалке */
.request-modal .iti {
    width: 100%;
}
.request-modal .iti__country-list {
    background: #0c1315;
    border: 1px solid #bfa37c;
    color: #fff;
}
.request-modal .iti__country:hover,
.request-modal .iti__country.iti__highlight {
    background: rgba(191,163,124,0.2);
}
.request-modal .iti__dial-code {
    color: #bfa37c;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
<script>
Fancybox.bind("[data-fancybox]", {});

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('request-modal');
    const openBtn = document.getElementById('open-request-modal');
    const closeBtn = document.getElementById('close-request-modal');
    const overlay = document.querySelector('.request-modal__overlay');
    
    // Инициализация intl-tel-input
    const phoneInput = document.getElementById('modal-phone-input');
    const iti = window.intlTelInput(phoneInput, {
        initialCountry: "it",
        preferredCountries: ["it", "ch", "gb", "fr", "de", "mc", "ae", "us"],
        separateDialCode: true,
        utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"
    });
    
    // Открытие календаря по клику на всё поле
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.addEventListener('click', function() { this.showPicker(); });
    });
    
    // Открыть/закрыть модалку
    openBtn.onclick = () => modal.style.display = 'flex';
    closeBtn.onclick = () => modal.style.display = 'none';
    overlay.onclick = () => modal.style.display = 'none';
    
    // Отправка формы
    document.getElementById('car-request-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = document.getElementById('modal-submit-btn');
        
        const fullPhone = iti.getNumber();
        if (!fullPhone || fullPhone.length < 8) {
            alert('Please enter a valid phone number');
            return;
        }
        formData.set('full_phone', fullPhone);
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>Sending...</span>';
        
        fetch('/api/car-request/', {
            method: 'POST',
            headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Thank you! We will contact you shortly.');
                modal.style.display = 'none';
                this.reset();
            } else {
                alert(data.error || 'Error sending request');
            }
        })
        .catch(() => alert('Network error. Please try again.'))
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>Send Request</span><span class="bg-effect"></span>';
        });
    });
});
</script>
{% endblock %}